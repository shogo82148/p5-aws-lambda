AWSTemplateFormatVersion: 2010-09-09
Description: ECR Repository for Perl AWS Lambda runtime

Resources:
  Repository:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::ECR::PublicRepository
    Properties:
      RepositoryName: p5-aws-lambda
      RepositoryCatalogData:
        OperatingSystems: [ Linux ]
        Architectures: [ x86-64 ]
        RepositoryDescription: Perl runtime for AWS Lambda
        AboutText: |
          This is Perl runtime for AWS Lambda based on [lambda/provided](https://gallery.ecr.aws/lambda/provided).
          It contains pre-built [perl](https://www.perl.org/) binary and [AWS::Lambda](https://metacpan.org/pod/AWS::Lambda)
          that is one of Lambda Runtime Interface Client for Perl.

          # IMAGE TAGS

          The following tags are based on Amazon Linux 2.

          - `base-<version>.al2`
            - The image based on [lambda/provided](https://gallery.ecr.aws/lambda/provided) Amazon Linux 2
            - You can customize this and deploy your images to AWS Lambda
          - `base-<version>-paws.al2`
            - The image based on [lambda/provided](https://gallery.ecr.aws/lambda/provided) Amazon Linux 2
            - It also contains [Paws](https://metacpan.org/pod/Paws) that is a Perl SDK for AWS APIs
          - `build-<version>.al2`
            - The image based on [lambci/lambda](https://hub.docker.com/r/lambci/lambda/) Amazon Linux 2
            - You can build CPAN modules on your local machines
          - `build-<version>-paws.al2`
            - The image based on [lambci/lambda](https://hub.docker.com/r/lambci/lambda/) Amazon Linux 2
            - It also contains [Paws](https://metacpan.org/pod/Paws) that is a Perl SDK for AWS APIs
          - `<version>.al2`
            - The image based on [lambci/lambda](https://hub.docker.com/r/lambci/lambda/) Amazon Linux 2
            - You can run your Lambda functions on your local machines
          - `<version>-paws.al2`
            - The image based on [lambci/lambda](https://hub.docker.com/r/lambci/lambda/) Amazon Linux 2
            - It also contains [Paws](https://metacpan.org/pod/Paws) that is a Perl SDK for AWS APIs

          These are based on Amazon Linux.

          - `base-<version>`
          - `base-<version>-paws`
          - `build-<version>`
          - `build-<version>-paws`
          - `<version>`
          - `<version>-paws`

          # SEE ALSO

          - [AWS::Lambda on metacpan](https://metacpan.org/pod/AWS::Lambda)
          - [shogo82148/p5-aws-lambda on GitHub](https://github.com/shogo82148/p5-aws-lambda)
          - [Paws](https://metacpan.org/pod/Paws)
          - [lambda/provided](https://gallery.ecr.aws/lambda/provided)
          - [lambci/lambda](https://hub.docker.com/r/lambci/lambda/)

        UsageText: |
          # Build and Deploy Docker Images

          TODO

          # Build Zip Archives

          TODO

          # Run AWS Lambda Function on Local Machines

          TODO

  StateBucket:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::S3::Bucket
    Properties:
      BucketName: shogo82148-lambda-perl-runtime-state
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  DeploymentUser:
    Type: AWS::IAM::User
    Properties:
      Policies:
        - PolicyName: Deployment
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - "ecr-public:*"
                Resource:
                  - !Sub "arn:aws:ecr-public::${AWS::AccountId}:repository/p5-aws-lambda"
              - Effect: Allow
                Action:
                  - "ecr-public:GetAuthorizationToken"
                  - "sts:GetServiceBearerToken"
                Resource: "*"
              - Effect: Allow
                Action:
                  - "s3:*"
                Resource:
                  - !GetAtt StateBucket.Arn
                  - !Sub "${StateBucket.Arn}/*"
  DeploymentAccessKey:
    Type: AWS::IAM::AccessKey
    Properties:
      Status: Active
      UserName: !Ref DeploymentUser

Outputs:
  DeploymentAccessKey:
    Value: !Ref DeploymentAccessKey
    Description: deployment access key
  DeploymentSecretKey:
    Value: !GetAtt DeploymentAccessKey.SecretAccessKey
    Description: deployment secret access key
